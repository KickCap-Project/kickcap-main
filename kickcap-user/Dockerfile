FROM node:20.15 as build

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

# ARG 선언 및 환경 변수 설정
ARG REACT_APP_BASE_URL
ARG REACT_APP_FCM_APIKEY
ARG REACT_APP_FCM_AUTH_DOMAIN
ARG REACT_APP_FCM_PROJECT_ID
ARG REACT_APP_FCM_STORAGE_BUCKET
ARG REACT_APP_FCM_MESSAGING_SENDERID
ARG REACT_APP_FCM_APPID
ARG REACT_APP_FCM_MEASUREMENT_ID
ARG REACT_APP_FCM_VAPID
ARG REACT_APP_KAKAO_MAP
ARG REACT_APP_KAKAO_REST
ARG REACT_APP_IMG_SERVER_BASE_URL
ARG REACT_APP_IMPORT


ENV REACT_APP_BASE_URL=${REACT_APP_BASE_URL}
ENV REACT_APP_FCM_APIKEY=${REACT_APP_FCM_APIKEY}
ENV REACT_APP_FCM_AUTH_DOMAIN=${REACT_APP_FCM_AUTH_DOMAIN}
ENV REACT_APP_FCM_PROJECT_ID=${REACT_APP_FCM_PROJECT_ID}
ENV REACT_APP_FCM_STORAGE_BUCKET=${REACT_APP_FCM_STORAGE_BUCKET}
ENV REACT_APP_FCM_MESSAGING_SENDERID=${REACT_APP_FCM_MESSAGING_SENDERID}
ENV REACT_APP_FCM_APPID=${REACT_APP_FCM_APPID}
ENV REACT_APP_FCM_MEASUREMENT_ID=${REACT_APP_FCM_MEASUREMENT_ID}
ENV REACT_APP_FCM_VAPID=${REACT_APP_FCM_VAPID}
ENV REACT_APP_KAKAO_MAP=${REACT_APP_KAKAO_MAP}
ENV REACT_APP_KAKAO_REST=${REACT_APP_KAKAO_REST}
ENV REACT_APP_IMG_SERVER_BASE_URL=${REACT_APP_IMG_SERVER_BASE_URL}
ENV REACT_APP_IMPORT=${REACT_APP_IMPORT} 

# 환경 변수가 빌드에 제대로 반영되는지 확인
RUN echo "REACT_APP_BASE_URL=$REACT_APP_BASE_URL" >> .env && \
    echo "REACT_APP_FCM_APIKEY=$REACT_APP_FCM_APIKEY" >> .env && \
    echo "REACT_APP_FCM_AUTH_DOMAIN=$REACT_APP_FCM_AUTH_DOMAIN" >> .env && \
    echo "REACT_APP_FCM_PROJECT_ID=$REACT_APP_FCM_PROJECT_ID" >> .env && \
    echo "REACT_APP_FCM_STORAGE_BUCKET=$REACT_APP_FCM_STORAGE_BUCKET" >> .env && \
    echo "REACT_APP_FCM_MESSAGING_SENDERID=$REACT_APP_FCM_MESSAGING_SENDERID" >> .env && \
    echo "REACT_APP_FCM_APPID=$REACT_APP_FCM_APPID" >> .env && \
    echo "REACT_APP_FCM_MEASUREMENT_ID=$REACT_APP_FCM_MEASUREMENT_ID" >> .env && \
    echo "REACT_APP_FCM_VAPID=$REACT_APP_FCM_VAPID" >> .env && \
    echo "REACT_APP_KAKAO_MAP=$REACT_APP_KAKAO_MAP" >> .env && \
    echo "REACT_APP_KAKAO_REST=$REACT_APP_KAKAO_REST" >> .env && \
    echo "REACT_APP_IMG_SERVER_BASE_URL=$REACT_APP_IMG_SERVER_BASE_URL" >> .env && \
    echo "REACT_APP_IMG_SERVER_BASE_URL=$REACT_APP_IMG_SERVER_BASE_URL" .env
    
# 빌드 실행
RUN npm run build

RUN rm .env

FROM nginx:alpine
COPY --from=build /app/build /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]